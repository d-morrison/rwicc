# GitHub Copilot Instructions for rwicc

## Project Overview

`rwicc` (“Regression With Interval-Censored Covariates”) is an R package
implementing statistical analysis for regression models involving
interval-censored covariates. The package is published on CRAN and
implements methods described in Morrison, Laeyendecker, and Brookmeyer
(Biometrics, 2021):
<https://onlinelibrary.wiley.com/doi/10.1111/biom.13472>.

The package uses a joint model for the distributions of the outcome of
interest and the interval-censored covariate, which is treated as a
latent variable. Model parameters are estimated by maximum likelihood
using an EM algorithm.

## Technology Stack

- **Language**: R (version 4.0+)
- **Package System**: Standard R package structure with roxygen2
  documentation
- **Testing**: testthat (edition 3)
- **Code Style**: tidyverse style guide
- **CI/CD**: GitHub Actions workflows
- **Version Control**: Git/GitHub

## Development Setup

### Prerequisites

1.  R (version 4.0 or later recommended)
2.  RStudio (optional but recommended)
3.  pandoc (for building vignettes and documentation)

### Installation

To install development dependencies:

``` r
# Install devtools if not already installed
install.packages("devtools")

# Install package dependencies
devtools::install_deps(dependencies = TRUE)
```

### Key Dependencies

The package imports: - `dplyr`, `magrittr`, `rlang` - data
manipulation - `ggplot2`, `plotly`, `ggrepel`, `scales` -
visualization - `biglm`, `stats`, `arm` - statistical modeling -
`lubridate` - date handling - `testthat`, `vdiffr`, `withr` - testing
utilities

## Build, Test, and Lint Commands

### Building the Package

``` r
# Build package documentation
devtools::document()

# Install and reload package
devtools::load_all()

# Check package (equivalent to R CMD check)
devtools::check()
```

### Running Tests

``` r
# Run all tests
devtools::test()

# Run tests with coverage
covr::package_coverage()

# Run specific test file
testthat::test_file("tests/testthat/test-plot_censoring_data.R")
```

### Linting

``` r
# Lint the entire package
lintr::lint_package()

# Lint a specific file
lintr::lint("R/fit_joint_model.R")
```

### Spell Checking

``` r
# Run spell check
spelling::spell_check_package()
```

## Code Style and Conventions

### General Guidelines

1.  **Follow tidyverse style guide**: Use the tidyverse style guide for
    R code
2.  **Use roxygen2 for documentation**: All exported functions must have
    roxygen2 documentation with `@param`, `@return`, `@examples`, and
    `@export` tags
3.  **Use pipe operators**: Prefer the native R pipe (`|>`) for data
    manipulation. The codebase is transitioning from magrittr pipe
    (`%>%`) to native pipe
4.  **Explicit imports**: Use explicit imports in NAMESPACE via roxygen2
    `@importFrom` tags

### Naming Conventions

- **Functions**: Use snake_case (e.g., `fit_joint_model`,
  `plot_censoring_data`)
- **Variables**: Use snake_case (e.g., `participant_level_data`,
  `obs_level_data`)
- **Constants**: Use UPPER_CASE for true constants (rare in R)
- **Private functions**: Not exported; document with
  `#' @keywords internal` if needed

### Documentation Standards

- All exported functions must have complete roxygen2 documentation
- Include `@references` for published methods
- Include `@examples` that demonstrate function usage
- Use `\doi{}` for DOI references in documentation
- Document all parameters with `@param`
- Describe return values with `@return`

### Code Organization

- Main statistical functions in `R/fit_*.R` files
- Plotting functions in `R/plot_*.R` files
- Utility functions in `R/utils.R`
- Package-level documentation in `R/rwicc-package.R`

## Package Structure

    rwicc/
    ├── R/                          # R source code
    │   ├── fit_joint_model.R      # Main EM algorithm implementation
    │   ├── fit_midpoint_model.R   # Midpoint imputation model
    │   ├── fit_uniform_model.R    # Uniform imputation model
    │   ├── plot_*.R               # Plotting functions
    │   ├── simulate_*.R           # Data simulation functions
    │   └── utils.R                # Helper functions
    ├── man/                        # Generated documentation (don't edit directly)
    ├── tests/
    │   └── testthat/              # Test files (test-*.R pattern)
    ├── vignettes/                 # Package vignettes
    ├── inst/                      # Installed files
    ├── DESCRIPTION                # Package metadata
    ├── NAMESPACE                  # Generated by roxygen2 (don't edit directly)
    └── README.Rmd                 # Source for README.md

## Testing Guidelines

### Test Structure

- Tests use testthat (edition 3)
- Test files follow pattern `test-<source-file>.R`
- Use `test_that()` for individual test cases
- Use descriptive test names

### Testing Practices

1.  **Snapshot testing**: Use
    [`vdiffr::expect_doppelganger()`](https://vdiffr.r-lib.org/reference/expect_doppelganger.html)
    for plot tests
2.  **Seed setting**: Use
    [`withr::local_seed()`](https://withr.r-lib.org/reference/with_seed.html)
    for reproducible random tests
3.  **Data simulation**: Use package’s
    [`simulate_interval_censoring()`](https://d-morrison.github.io/rwicc/reference/simulate_interval_censoring.md)
    for test data
4.  **Filter data appropriately**: Subset simulated data to manageable
    sizes for tests

### Example Test Pattern

``` r
test_that("descriptive test name", {
  withr::local_seed(16)
  
  sim_data <- simulate_interval_censoring(
    study_cohort_size = 2,
    years_in_study = 10,
    probability_of_ever_seroconverting = 1
  )
  
  # Test expectations here
  expect_true(condition)
})
```

## CI/CD Workflows

The repository uses GitHub Actions for continuous integration:

1.  **R-CMD-check** (`.github/workflows/R-CMD-check.yaml`): Runs on
    multiple OS/R version combinations
2.  **lint** (`.github/workflows/lint.yaml`): Runs lintr::lint_package()
3.  **test-coverage** (`.github/workflows/test-coverage.yaml`):
    Generates and uploads coverage reports to Codecov
4.  **render-rmarkdown** (`.github/workflows/render-rmarkdown.yaml`):
    Re-renders README.Rmd if changed
5.  **pkgdown** (`.github/workflows/pkgdown.yaml`): Builds and deploys
    package website

All workflows run on push to main/master branches and on pull requests.

## Important Notes

### Working with Dates

- Use `lubridate` for date operations
- Study dates are typically represented as Date objects
- Date variables in data: `E` (enrollment), `L` (last negative), `R`
  (first positive), `O` (observation)

### Statistical Methods

- The package implements EM algorithms for parameter estimation
- Convergence criteria use both log-likelihood changes
  (`EM_toler_loglik`) and parameter changes (`EM_toler_est`)
- Numerical stability considerations are important (e.g., `denom_offset`
  parameter)

### Data Structures

The package typically works with two types of data frames: 1.
**Participant-level data**: Contains ID, E, L, R, and optionally Cohort
2. **Observation-level data**: Contains ID, O, Y (outcome)

### Making Changes

- Always run `devtools::document()` after modifying roxygen2 comments
- Run `devtools::check()` before submitting changes
- Ensure all tests pass with `devtools::test()`
- Update README.Rmd (not README.md directly) if changing documentation
- Maintain backward compatibility for exported functions

## Getting Help

- Project URL: <https://d-morrison.github.io/rwicc/>
- GitHub: <https://github.com/d-morrison/rwicc>
- Contact: <demorrison@ucdavis.edu>
- Reference paper: Morrison et al. (2021), Biometrics.
  <https://doi.org/10.1111/biom.13472>
